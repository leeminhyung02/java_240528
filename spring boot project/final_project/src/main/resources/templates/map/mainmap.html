<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout.html}">
<head>
<script type="text/javascript"
	src="//dapi.kakao.com/v2/maps/sdk.js?appkey=&libraries=services,clusterer,drawing">
		</script>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<main layout:fragment="content">
		<div id="map" style="width: 100%; height: 500px;"></div>
		<div class="container">
			<h2>리스트 출력</h2>
			<div style="width: 100%; height: 300px;">
				<table class="table table-hover">
					<thead>
						<tr>
							<th>가게이름</th>
							<th>평점</th>
							<th>정보</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="item : ${list}">
							<td th:text="${item.res_name}"></td>
							<td th:text="${item.res_score}"></td>
							<td th:text="${item.res_info}"></td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<script th:inline="javascript">
	
	function displayMap() {

		if ("geolocation" in navigator) {
			/* 위치정보 사용 가능 */
			navigator.geolocation.getCurrentPosition(success, fail, {enableHighAccuracy: true});
			function success(pos) { // 위치 정보를 가져오는데 성공했을 때 호출되는 콜백 함수 (pos : 위치 정보 객체)
			    const lat = pos.coords.latitude;
			    const lng = pos.coords.longitude;
			    console.log(`현위치 : ${lat}, ${lng}`);
				var container = document.getElementById('map');
				var options = {
					center: new kakao.maps.LatLng(37.49923299038047, 127.0327758638022),
					level: 4
				};
				var map = new kakao.maps.Map(container, options);
				var geocoder = new kakao.maps.services.Geocoder();
				function makeOverListener(map, marker, infowindow) {
				    return function() {
				        infowindow.open(map, marker);
				    };
				}
				// 인포윈도우를 닫는 클로저를 만드는 함수입니다 
				function makeOutListener(infowindow) {
				    return function() {
				        infowindow.close();
				    };
				}
				//ajax로 동기 통신으로 DB에 저장된 정보들을 가져옴 
				$.ajax({
					async : false, //비동기 : true(비동기), false(동기)
					url : '/map/mainmap', 
					type : 'post',  
					dataType : 'json', 
					success : function (data){

						data.list.forEach((item, index)=>{

							geocoder.addressSearch(item.address, function(result, status) {
							    
								// 정상적으로 검색이 완료됐으면 
							     if (status === kakao.maps.services.Status.OK) {
							        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
							       // if(result[0].y < lat +0.01 && result[0].y > lat -0.01 && result[0].x < lng +0.01 && result[0].x > lng - 0.01){
							        // 결과값으로 받은 위치를 마커로 표시합니다
							    	display(item, coords, map, makeOverListener, makeOutListener)
								       
							    }
							}); 
						});

					}, 
					error : function(jqXHR, textStatus, errorThrown){
					} 
				});
			}
			function fail(err) { // 위치 정보를 가져오는데 실패했을 때 호출되는 콜백 함수
			    alert('현위치를 찾을 수 없습니다.');
			}
		} else {
		  /* 위치정보 사용 불가능 */
		  alert('위치 사용 불가능');
		}
	}
	displayMap();
	function display(item , coords, map, makeOverListener, makeOutListener){
		
		console.log(item)
		console.log(coords)
		 var marker = new kakao.maps.Marker({
	            map: map,
	            position: coords
        });
        var infowindow = new kakao.maps.InfoWindow({
            content:'<div>' + item.res_name + '<div>' // 인포윈도우에 표시할 내용
        });
        kakao.maps.event.addListener(marker, 'mouseover', makeOverListener(map, marker, infowindow));
        kakao.maps.event.addListener(marker, 'mouseout', makeOutListener(infowindow));
    
	}
	</script>
	</main>
</body>
</html>